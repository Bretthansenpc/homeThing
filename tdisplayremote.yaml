esphome:
  name: lilygo_display
  platform: ESP32
  board: featheresp32

packages:
  device_base: !include common/device_base.yaml

font:
  ## Font needs to be monospace!
    - file: "fonts/iosevka-heavy.ttf"
      id: large_heavy_font
      size: 24
      glyphs: '^…*/|\$#<>!?"%()[]+=,-_.:°0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ abcdefghijklmnopqrstuvwxyz&êÊîÎâÂôÔéÉíÍáÁóÓëËüÜïÏöÖøØṣṢñãõÑÃÕ''’'
    - file: "fonts/iosevka.ttf"
      id: large_font
      size: 24
      glyphs: '^…*/|\$#<>!?"%()[]+=,-_.:°0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ abcdefghijklmnopqrstuvwxyz&êÊîÎâÂôÔéÉíÍáÁóÓëËüÜïÏöÖøØṣṢñãõÑÃÕ''’'
    - file: "fonts/iosevka.ttf"
      id: medium_font
      size: 15
      glyphs: '^…*/|\$#<>!?"%()[]+=,-_.:°0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ abcdefghijklmnopqrstuvwxyz&êÊîÎâÂôÔéÉíÍáÁóÓëËüÜïÏöÖøØṣṢñãõÑÃÕ''’'
    - file: "fonts/iosevka.ttf"
      id: small_font
      size: 14
      glyphs: '^…*/|\$#<>!?"%()[]+=,-_.:°0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ abcdefghijklmnopqrstuvwxyz&êÊîÎâÂôÔéÉíÍáÁóÓëËüÜïÏöÖøØṣṢñãõÑÃÕ''’'
    - file: 'fonts/homeThingFontLogo.ttf' 
      id: home_thing_logo
      size: 48
      glyphs: [
        '',
      ]  
    - file: 'fonts/materialdesignicons-webfont.ttf' 
      id: material_font_large
      size: 19
      glyphs: [
        '󰐊', # mdi-play
        '󰓛', # mdi-stop
        '󰏤', # home-pause
        '󰽥', # mdi-moon-waning-crescent
        '󰒝', # mdi-shuffle
        '󰒞', # mdi-shuffle-disabled
        '󰕾', # mdi-volume-high
        '󰕿', # mdi-volume-low
        '󰚺', # mdi-plex
        '󰝆', # mdi-netflix
        '󰗃', # mdi-youtube
        '󰓇', # mdi-spotify
        '󰔂', # mdi-television
        '󰋜', # mdi-home
        '󰌵', # mdi-lightbulb
        '󰌶', # mdi-lightbulb-outline
      ]  
    - file: 'fonts/materialdesignicons-webfont.ttf' 
      id: material_font_small
      size: 18
      glyphs: [
        '󰐊', # mdi-play
        '󰓛', # mdi-stop
        '󰏤', # home-pause
        '󰽥', # mdi-moon-waning-crescent
        '󰒝', # mdi-shuffle
        '󰒞', # mdi-shuffle-disabled
        '󰕾', # mdi-volume-high
        '󰕿', # mdi-volume-low
        '󰚺', # mdi-plex
        '󰝆', # mdi-netflix
        '󰗃', # mdi-youtube
        '󰓇', # mdi-spotify
        '󰔂', # mdi-television
        '󰋜', # mdi-home
        '󰌵', # mdi-lightbulb
        '󰌶', # mdi-lightbulb-outline
      ]

deep_sleep:
  id: deep_sleep_

sensor:
  - platform: rotary_encoder
    filters:
    - throttle: 0.01s
    name: "Rotary Encoder"
    internal: true
    pin_a:
      number: 12
      mode:
        input: true
        pullup: true
    pin_b:
      number: 13
      mode:
        input: true
        pullup: true
    id: rotary
    on_clockwise:
      - lambda: |-
          id(homeThingMenu)->buttonPressWakeUpDisplay();
          id(homeThingMenu)->rotaryScrollClockwise(id(rotary).state);
    on_anticlockwise:
      - lambda: |-
          id(homeThingMenu)->buttonPressWakeUpDisplay();
          id(homeThingMenu)->rotaryScrollCounterClockwise(id(rotary).state);
## Battery
  - platform: adc
    pin: 34
    attenuation: 11db
    name: "vccadc"
    update_interval: 250ms
    id: vcc_adc
    internal: true
    on_value:
      then:
        lambda: |-
          if (!id(charging)->has_state()) {
              id(charging)->publish_state(false);
          } else if (id(vcc_adc).state > 2.23) {
            if (!id(charging).state) {
              id(charging)->publish_state(true);
            }
          } else {
            if (id(charging).state) {
              id(charging)->publish_state(false);
            }
          }
          id(vcc_adc_avg).publish_state(id(vcc_adc).state);
  - platform: template
    id: vcc_adc_avg
    filters:
      - sliding_window_moving_average:
          window_size: 4
          send_every: 4
    on_value :
      then:
        - sensor.template.publish:
            id: batteryVoltage
            state: !lambda 'return id(vcc_adc).state;'
  - platform: template
    name: batteryVoltage
    id: batteryVoltage
    internal: true
    unit_of_measurement: 'V'
    on_value :
      then:
        - sensor.template.publish:
            id: battery_percent
            state: !lambda 'return (id(batteryVoltage).state * 118) - 162;'
  - platform: template
    name: Battery Percent
    id: battery_percent
    unit_of_measurement: '%'
    on_value_range:
      below: 5
      then:
        lambda: |-
          ESP_LOGE("SLEEP", "Low Power Supply %.3fV! Sleeping to protect battery", id(battery_percent).state);
          id(sleep_toggle).turn_on();

binary_sensor:
  - platform: template
    id: charging
  - platform: gpio
    pin:
      number: GPIO0
      inverted: true
      mode:
        input: true
        pullup: true
    name: "T-Display Button Input 0"
    id: tdisplay_button_input_0
    internal: true
    on_press:
      then:
      - lambda: |-
          id(homeThingMenu)->buttonPressScreenLeft();
    on_release:
      then:
      - lambda: |-
          id(homeThingMenu)->buttonReleaseScreenLeft();
  - platform: gpio
    pin:
      number: GPIO35
      inverted: true
    name: "T-Display Button Input 1"
    id: tdisplay_button_input_1
    internal: true
    on_press:
      then:
      - lambda: |-
          id(homeThingMenu)->buttonPressScreenRight();
  - platform: gpio
    internal: true
    pin:
      number: 21
      inverted: true
      mode:
        input: true
        pullup: true
    id: sw5
    on_press:
      then:
      - lambda: |-
          id(homeThingMenu)->buttonPressLeft();
  - platform: gpio
    internal: true
    pin:
      number: 22
      inverted: true
      mode:
        input: true
        pullup: true
    id: sw4
    on_press:
      then:
      - lambda: |-
          id(homeThingMenu)->buttonPressUp();
  - platform: gpio
    internal: true
    pin:
      number: 17
      inverted: true
      mode:
        input: true
        pullup: true
    id: sw3
    on_press:
      then:
      - lambda: |-
          id(homeThingMenu)->buttonPressRight();
  - platform: gpio
    internal: true
    pin:
      number: 2
      inverted: true
      mode:
        input: true
        pullup: true
    id: sw2
    on_press:
      then:
      - lambda: |-
          id(homeThingMenu)->buttonPressDown();
  - platform: gpio
    internal: true
    pin:
      number: 15
      inverted: true
      mode:
        input: true
        pullup: true
    id: sw1
    on_click:
      min_length: 5ms
      max_length: 350ms
      then:
      - lambda: |-
          id(homeThingMenu)->buttonPressSelect();
    on_multi_click:
    - timing:
        - ON for at least 0.5s
      then:
      - lambda: |-
          id(homeThingMenu)->buttonPressSelectHold();

switch:
  - platform: gpio
    pin:
      number: 27
      inverted: false
    id: comb
    internal: true
  - platform: gpio
    pin:
      number: 26
      inverted: false
    id: coma
    internal: true
  - platform: template
    name: Sleep Toggle
    id: sleep_toggle
    optimistic: true
    on_turn_on:
      then:
        - deep_sleep.enter:
            id: deep_sleep_
  - platform: gpio
    pin: GPIO4
    name: "Backlight"
    id: backlight
    internal: true
    restore_mode: RESTORE_DEFAULT_ON

spi:
  clk_pin: GPIO18
  mosi_pin: GPIO19

homeThing:
  id: homeThingMenu
  sleep_switch: sleep_toggle
  backlight: backlight
  battery:
    battery_percent: battery_percent
    charging: charging
  media_players: media_group_component
  lights: light_group_component
  services: service_group_component
  sensors: sensor_group_component
  switches: switch_group_component
  display: my_display
  on_redraw:
    then:
      component.update: my_display
  boot:
    api: api_connected
  display_state:
    draw_battery_level: true
    font_small: small_font
    font_medium: medium_font
    font_large: large_font
    font_large_heavy: large_heavy_font
    font_material_large: material_font_large
    font_material_small: material_font_small
    font_logo: home_thing_logo

display:
  - platform: st7789v
    model: TTGO_TDisplay_135x240
    id: my_display
    backlight_pin: GPIO4
    cs_pin: GPIO5
    dc_pin: GPIO16
    reset_pin: GPIO23
    rotation: 90
    update_interval: 10s
    lambda: |-
      id(homeThingMenu)->draw_menu_screen();
      return;

